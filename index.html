<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тайнствената гора — интерактивна приказка</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#151820; --frame:#2a2d33;
      --fg:#e8e4d8; --muted:#bfb9a7;
      --btn:#d7b36a; --btnB:#8c6a2b; --btnText:#27170b;
      --accent:#f1d088;
      --shadow:0 12px 30px rgba(0,0,0,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(1200px 700px at 50% 0%, #11151c 0%, var(--bg) 60%);
      color:var(--fg);
      font:16px/1.55 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      display:flex; align-items:center; justify-content:center;
      padding:20px;
    }
    #app{
      width:min(1400px, 100%);
      display:flex; flex-direction:column; gap:14px;
    }
    .frame{
      background:linear-gradient(180deg,#13171d,#101419);
      border:1px solid #3a3f47; border-radius:18px; padding:14px;
      box-shadow:var(--shadow);
    }
    .stage{
      background:#0f1217; border:1px solid var(--frame);
      border-radius:12px; overflow:hidden; position:relative;
      min-height:55vh;
    }
    .stage img{
      display:block; width:100%; height:70vh; object-fit:cover;
      object-position:center;
      filter:contrast(1.05) saturate(.95) brightness(.95);
      animation:fade .4s ease-out both;
      background:#0c0f13;
    }
    @media (max-height:850px){ .stage img{ height:62vh; } }
    @keyframes fade{ from{opacity:0; transform:scale(1.005)} to{opacity:1; transform:scale(1)} }

    .panel{
      background:linear-gradient(180deg,#141821 0%,#10141a 100%);
      border-top:1px solid #2e3239; padding:16px 18px;
      display:flex; flex-direction:column; gap:12px;
    }
    .text{
      color:var(--fg);
      font-size:1.05rem;
      text-wrap:pretty;
      white-space:pre-wrap;
    }
    .buttons{ display:flex; flex-wrap:wrap; gap:10px }
    .btn{
      background:linear-gradient(180deg, var(--btn), #c59c48);
      color:var(--btnText);
      border:1px solid var(--btnB);
      border-bottom-width:2px;
      padding:10px 16px; border-radius:12px;
      cursor:pointer; font-weight:600; letter-spacing:.2px;
      transition:transform .05s ease, filter .15s ease;
      box-shadow:0 2px 0 rgba(0,0,0,.35);
      user-select:none;
    }
    .btn:hover{ filter:brightness(1.03) }
    .btn:active{ transform:translateY(1px) }

    .hud{
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted); font-size:.9rem; gap:8px;
      padding:0 2px;
    }
    .small{ opacity:.75 }
    .linklike{ color:var(--accent); text-decoration:underline; cursor:pointer }
  </style>
</head>
<body>
  <main id="app">
    <section class="frame stage">
      <img id="slideImg" alt="сцена" />
    </section>

    <section class="frame panel" id="panel" hidden>
      <div class="text" id="slideText"></div>
      <div class="buttons" id="btns"></div>
      <div class="hud">
        <div class="small">Сцена: <span id="idOut">—</span></div>
        <div class="small linklike" id="restart">Започни отначало</div>
      </div>
    </section>
  </main>

  <script>
    const state = { flow:null, id:null };

    const els = {
      img: document.getElementById('slideImg'),
      text: document.getElementById('slideText'),
      btns: document.getElementById('btns'),
      panel: document.getElementById('panel'),
      idOut: document.getElementById('idOut'),
      restart: document.getElementById('restart'),
    };

    fetch('flow.json?'+Date.now())
      .then(r => r.json())
      .then(flow => { state.flow = flow; go(flow.start || 'S1'); })
      .catch(err => { console.error(err); alert('Грешка при зареждане на flow.json'); });

    function go(id){
      const slide = state.flow.slides[id];
      if(!slide){ console.warn('Липсва слайд', id); return; }
      state.id = id;

      // изображение
      const src = `slides/${slide.img}`;
      els.img.src = src;
      els.img.alt = slide.text ? slide.text.replace(/\n/g,' ').slice(0,120) : 'сцена';

      // текст
      const hasText = slide.text && slide.text.trim().length>0;
      els.text.textContent = hasText ? slide.text : '';
      els.panel.hidden = false; // показваме панела винаги (ако искаш да се крие при празен текст — смени на: els.panel.hidden = !hasText)

      // бутони
      els.btns.innerHTML = '';
      (slide.buttons || []).forEach(b=>{
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = b.label || 'Продължи';
        btn.onclick = ()=> go(b.to);
        els.btns.appendChild(btn);
      });

      els.idOut.textContent = id + ' • ' + slide.img;
      window.scrollTo({top:0, behavior:'smooth'});
    }

    els.restart.onclick = ()=> go(state.flow.start || 'S1');

    // навигация с клавиатура: Enter → първи бутон
    window.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const first = els.btns.querySelector('.btn');
        if(first) first.click();
      }
    });
  </script>
</body>
</html>
